machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker
dependencies:
  override:
    - sudo pip install docker-compose
    - docker-compose up -d mariadb
    - docker-compose up -d nginx
test:
  pre:
#    - docker-compose run php mkdir vendor
#    - docker-compose run php touch composer.lock
#    - docker-compose run php chown -R 82:82 vendor
#    - docker-compose run php chown 82:82 composer.json
#    - docker-compose run php chown 82:82 composer.lock
    - docker-compose run php chown -R 82:82 sites
    - docker-compose run php chown -R 82:82 ./
    - docker-compose run --user 82 php composer global require "hirak/prestissimo:^0.3"
    - docker-compose run --user 82 php composer require "wikimedia/composer-merge-plugin:~1.3" --no-interaction
    - docker-compose run --user 82 php composer update --no-interaction
  override:
    - docker-compose run --user 82 php vendor/bin/phpunit -c core core/tests/Drupal/Tests/Core/Password/PasswordHashingTest.php
    - docker-compose run --user 82 php vendor/bin/phpunit -c core core/tests/Drupal/Tests/Component/Utility/HtmlTest.php
    - docker-compose run --user 82 php vendor/bin/phpunit -c core core/tests/Drupal/KernelTests/Component/Utility/SafeMarkupKernelTest.php
    - docker-compose run --user 82 php vendor/bin/phpunit -c core core/tests/Drupal/FunctionalTests/Breadcrumb/Breadcrumb404Test.php
    - docker-compose run --user 82 php vendor/bin/phpunit -c core core/tests/Drupal/FunctionalJavascriptTests/Core/Session/SessionTest.php
deployment:
  production:
    branch: /.*/
    commands:
      - tar -c --exclude='.git' --exclude='.gitignore' --exclude="./docker-runtime" . | gzip -9 | aws s3 cp - "s3://$AWS_S3_BUCKET/$AWS_S3_FILE_NAME-$CIRCLE_BUILD_NUM.tar.gz"
      - (cd ./scripts; composer update --no-interaction)
#      - php -f ./scripts/wodby.php

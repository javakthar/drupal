machine:
  php:
    version: 7.0.4
  hosts:
    localhost: 127.0.0.1    
dependencies:
  pre:
    - rm /opt/circleci/php/$(phpenv global)/etc/conf.d/xdebug.ini
    - curl https://drupalconsole.com/installer -L -o drupal.phar
    - php -r "readfile('https://drupalconsole.com/installer');" > drupal.phar
    - mv drupal.phar /usr/local/bin/drupal
    - chmod +x /usr/local/bin/drupal
    - drupal init --override
    - composer global require "hirak/prestissimo:^0.3"
    - composer require "wikimedia/composer-merge-plugin:~1.3" --no-interaction    
    - composer update --no-interaction
test:
  pre:
    - mysql -uubuntu -e "SHOW DATABASES;"
    - drush si standard --y --account-name=admin --account-pass=admin --db-url=mysql://ubuntu@localhost/circle_test
  override:
    - cd core && ../vendor/bin/phpunit tests/Drupal/Tests/Core/Password/PasswordHashingTest.php
    - php ./core/scripts/run-tests.sh --url http://localhost/ --dburl mysql://ubuntu@localhost/circle_test 'Drupal\Tests\Component\Utility\ArgumentsResolverTest'
deployment:
  production:
    branch: /.*/
    commands:
      - tar -c --exclude='.git' --exclude='.gitignore' --exclude='.composer' . | gzip -9 | aws s3 cp - "s3://$AWS_S3_BUCKET/$AWS_S3_FILE_NAME-$CIRCLE_BUILD_NUM.tar.gz"
      - (cd ./scripts; composer update --no-interaction)
      - php -f ./scripts/wodby.php

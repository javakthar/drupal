machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker
dependencies:
  pre:
    - sudo pip install docker-compose
    - docker-compose up -d
    - composer update --no-interaction
test:
  override:
    - docker-compose exec php sh
    - cp ./sites/default/default.settings.php ./sites/default/settings.php
    - mkdir -p ./sites/default/files
    - > 
      drupal --root=/var/www/html/web site:install standard --site-name="Drupal 8 via Docker" --langcode=en
      --db-type=mysql --db-pass=drupal --db-user=drupal --db-port=3306 --db-host=mariadb --db-name=drupal
      --site-mail=mail@example.com --account-pass=admin
    - chown -R www-data:www-data .
    - export SIMPLETEST_DB='mysql://drupal:drupal@mariadb/drupal'
    - export SIMPLETEST_BASE_URL='http://localhost:8000'
    - sudo -u www-data -E ./vendor/bin/phpunit -c core --testsuite functional
    - sudo -u www-data -E ./vendor/bin/phpunit -c core --testsuite functional-javascript
deployment:
  production:
    branch: /.*/
    commands:
      - tar -c --exclude='.git' --exclude='.gitignore' --exclude="./docker-runtime" . | gzip -9 | aws s3 cp - "s3://$AWS_S3_BUCKET/$AWS_S3_FILE_NAME-$CIRCLE_BUILD_NUM.tar.gz"
      - (cd ./scripts; composer update --no-interaction)
      - php -f ./scripts/wodby.php

